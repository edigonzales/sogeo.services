<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>State of WFS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link href="../../../../css/prettify.css" rel="stylesheet">
    <link href="../../../../css/sogeo.css" rel="stylesheet">

    <!-- web fonts -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,300' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.019/css/hack.min.css">
    
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../../favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
			<li><a href="../../../../index.html">Home</a></li>
			<li><a href="../../../../archive.html">Archive</a></li>
            <li><a href="../../../../feed.xml">Subscribe</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">

	<div class="page-header">
		<h1>State of WFS</h1>
	</div>

	<p class="date"><em>18 October 2015</em></p>

	<p><div class="paragraph">
<p>Oder wie soll man WFS &laquo;richtig&raquo; nutzen? Eines vorweg: ich weiss es nicht. Ein Direktzugriffsverfahren auf Daten mit Filterfunktionen ist toll und sinnvoll. Aber für mich stellen sich einige Fragen in zwei Themenfeldern:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Interaktion zwischen Benutzer und Service</p>
</li>
<li>
<p>Umgang mit grossen Datenmengen</p>
</li>
<li>
<p>Und irgendwie eine Kombination von beidem.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Die ganze Thematik mit <a href="http://docs.geoserver.org/stable/en/user/data/app-schema/index.html">Anwendungsschemen</a> und <a href="http://lists.osgeo.org/pipermail/mapserver-dev/2014-June/014087.html">komplexen Feature</a> lassen wir mal beiseite und gehen von good old <a href="https://www.google.ch/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0CCEQFjAAahUKEwi17pPNuMzIAhWLVxoKHUvAC0E&amp;url=http%3A%2F%2Fportal.opengeospatial.org%2Ffiles%2F%3Fartifact_id%3D15201&amp;usg=AFQjCNGwftPpYIra3XPRMDwfqb-BGETqyw&amp;sig2=slYt5wNVI48Niy8Ri6TXnw">OGC SF-0</a> aus. Das heisst <a href="http://docs.geoserver.org/stable/en/user/data/app-schema/complex-features.html#simple-features">eine Tabelle aus der Datenbank wird zu einem WFS-Layer</a>, der mit einem <code>GetFeature</code>-Request heruntergeladen werden kann. Solche WFS-Server gibt es wie Sand am Mehr (<a href="http://geoserver.org/">GeoServer</a>, <a href="http://hub.qgis.org/projects/quantum-gis/wiki/qgis_server_tutorial">QGIS Server</a>, <a href="http://mapserver.org/">MapServer/TinyOWS</a>, <a href="http://www.deegree.org/">deegree</a>).</p>
</div>
<div class="paragraph">
<p>Die Unterstützung in den Desktop-GIS wie z.B. <a href="http://www.qgis.org">QGIS</a> ist auf den ersten Blick nicht allzu übel. Unterstützt wird die Version 1.0.0. Das Einbinden von WFS-Layer ist einfach und ähnlich dem eines Postgis-Layers:</p>
</div>
<div class="videoblock">
<div class="content">
<iframe src="//www.youtube.com/embed/hgPlv4tUDGE?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>Im Video wird gezeigt, wie die Hoheitsgrenzen des Kantons Solothurn in QGIS geladen werden. &laquo;In QGIS geladen&raquo; bedeutet, dass die Vektordaten komplett vom WFS-Server heruntergeladen werden und in QGIS in einem Memory-Layer gespeichert werden. Wird QGIS geschlossen, werden die Daten nirgends auf dem Computer gespeichert und beim Öffnen des QGIS-Projektes werden die Daten vom WFS-Server <em>erneut</em> heruntergeladen.</p>
</div>
<div class="paragraph">
<p>Soweit so gut. Die Hoheitsgrenzen werden zügig geladen. Es sind ja auch nur 110 Polygone. Auch das Nicht-Offline-Speichern und erneute Laden beim Öffnen des QGIS-Projektes hat was: So sind die Daten garantiert immer aktuell resp. entsprechen der Aktualität wie sie der Serviceprovider anbietet.</p>
</div>
<div class="paragraph">
<p>Schauen wir uns die Bodenbedeckung der amtlichen Vermessung an. Das sind im Kanton Solothurn knapp 280'000 Polygone:</p>
</div>
<div class="videoblock">
<div class="content">
<iframe src="//www.youtube.com/embed/Neerm1dweZo?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>Wird der WFS-Layer genau gleich geladen wie die Hoheitsgrenzen wartet der Benutzer 1.5 Minuten auf die Antwort. Das QGIS Fenster ist blockiert und auf dem Server läuft in diesem Zeitraum ein Prozess mit 100% CPU-Auslastung. Wird z.B. QGIS-Server verwendet, läuft neben der eigentlichen Verarbeitung des WFS-Request (als FCGI-Prozess) auch noch Apache mit 20% CPU-Auslastung. Speichert man das QGIS-Projekt und öffnet es wieder, wird dieser Request wiederholt. Der Benutzer wartet also bei jedem Öffnen des Projektes einige Minuten. Mir noch nicht klar warum das Abfragen von einzelnen Features (mit dem Identify Features Tool) so lange dauert. Eventuell wird beim Memory-Layer kein Spatial-Index erzeugt und daher wirkt die Feature-Abfrage so käsig.</p>
</div>
<div class="paragraph">
<p>Mit den Filterfunktionen kann der Problematik der langen Downloadzeit entgegen gewirkt werden. Einerseits kann nach Sachattributen (z.B. Gemeindenummer) gefiltert werden:</p>
</div>
<div class="videoblock">
<div class="content">
<iframe src="//www.youtube.com/embed/aAcTHfnoKlc?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>Man darf aber nicht vergessen, dass man ja nur nach Attributen filtern kann, die auch da sind. Fehlt im WFS-Layer das Attribute <code>bfsnr</code> kann <strong>nicht</strong> nach einer Gemeinde gefiltert werden.</p>
</div>
<div class="paragraph">
<p>Anderseits kann man geografisch filtern:</p>
</div>
<div class="videoblock">
<div class="content">
<iframe src="//www.youtube.com/embed/XbAWoqFtSVg?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>Auch das geht nicht immer: WFS-Layer ohne Geometrien können <strong>nicht</strong> geografisch gefiltert werden. An den Haaren herbeigezogen? Ich denke nicht. Denkbar sind Strassennamen oder ähnliches.</p>
</div>
<div class="paragraph">
<p>QGIS hat beim Hinzufügen von WFS-Layer eine interessante Option, die sich &laquo;Cache Features&raquo; nennt. Leider funktioniert sie mit der aktuellen QGIS-Version (2.10) nicht mehr. Im GUI ist die Option noch vorhanden aber die Funktion wurde im <a href="https://github.com/qgis/QGIS/blob/master/src/providers/wfs/qgswfsprovider.cpp#L126">Quellcode bewusst auskommentiert</a>. Äh..? Irgendwie ist da sowieso der <a href="http://lists.osgeo.org/pipermail/qgis-developer/2015-October/039642.html">Wurm</a> drin. Die Idee hinter &laquo;Cache Features&raquo; ist eben das oben beschriebene Verhalten, dh. <strong>alle</strong> Features des WFS-Layer werden in QGIS &laquo;gecached&raquo;/heruntergeladen. Wählt man jetzt diese Option ab (in QGIS 1.8 funktioniert das noch), werden die Features nicht mehr in QGIS gecached, sondern es werden nur die Features heruntergeladen, die dem aktuellen Kartenausschnitt entsprechen. Der Funktion ist sogar ein Mindestmass an Intelligenz eingepflanzt. So werden die Features nicht erneut geladen, wenn der neue Kartenausschnitt (nach Zoomen) komplett innerhalb des vorangegangenen Kartenausschnittes ist. Auf den ersten Blick ist das genau das Verhalten, das man sich eigentlich wünscht. Die Probleme beginnen aber beim Herauszoomen und am Schluss lädt es bei jedem Verschieben der Karte sehr lange, sehr viele Features herunter:</p>
</div>
<div class="videoblock">
<div class="content">
<iframe src="//www.youtube.com/embed/op7eWUm6wCI?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>Wie man aber auch sieht, funktioniert dieser <em>uncached</em> WFS-Layer bei grossen Massstäben (und dementensprechend wenig Feature, die nachgeladen werden müssen) ziemlich gut. Bei genügend schneller Internetverbindung merkt man das Nachladen praktisch gar nicht.</p>
</div>
<div class="paragraph">
<p>Nach all den Beispielen bleiben bei mir immer noch Fragen in den eingangs erwähnten Themenfeldern:</p>
</div>
<div class="paragraph">
<p>Darf das Herunterladen der Daten länger dauern oder soll der Benutzer die gleiche <em>User Experience</em> wie bei WMS haben? Bei kleinen Datenmengen scheint das ziemlich gut zu funktionieren. Bei grösseren überhaupt nicht mehr. Oder macht es eben nichts, wenn die Daten nicht mehr <em>instant</em> erscheinen, sondern es etliche Sekunden oder Minuten geht bis man wieder weiterarbeiten kann? Darf es Ziel der ganzen Übung sein die Daten einmalig herunterzuladen und dann lokal physisch zu speichern (als Shapefile o.ä.)? Ganz quer ist dieser Gedanke nicht: GML ist ja kein Produktionsformat, sondern ein Datenaustauschformat. Aber dann verliert man die Vorteile eines Direktzugriffsverfahrens.</p>
</div>
<div class="paragraph">
<p>Klar, es gibt <a href="http://www.opengeospatial.org/standards/filter">Filter</a>. Darf man aber erwarten, dass der Benutzer <em>immer</em> vorgängig die richtigen Filter kennt und auch einstellt? Zudem kann nur nach etwas gefiltert werden, was auch in den Daten vorhanden ist (&laquo;Ich will Daten der Gemeinde XY, kann aber keine Gemeindenummer beim Filter auswählen.&laquo;). Einmal Filter nicht gesetzt und schon dauert ein Download sehr lange und generiert Last.</p>
</div>
<div class="paragraph">
<p>Last: Die grossen WFS-Requests erzeugen eine hohe Last auf dem Server. Ich bin zwar keine Server-Admin-Guru aber ich glaube nicht, dass man von externen und unter Umständen unbekannten Leuten den Server unbewusst (Filter vergessen?) so einfach unter Volllast gesetzt bekommen will. Für GeoServer gibt es ein <a href="http://docs.geoserver.org/stable/en/user/extensions/controlflow/index.html">Control Flow Modul</a>, das die OWS-Requests detailliert kontrollieren kann. Bei QGIS-Server (FCGI-Process) kann/man/will man das wahrscheinlich teilweise direkt in den FCGI-Einstellungen regeln. Häufig gibt es auch die Möglichkeit auf der Serverseite die maximale Anzahl der Features zu limitieren, die auf eine Anfrage eines Klienten zurückgeschickt werden. Bis zur WFS-Version 2.0.0 wurde diese Anzahl dem Klienten nicht bekannt gegeben. Der Klient wusste also nicht, ob er alle angeforderten Features bekommen hat oder ob der Server die maximale Anzahl der auszuliefernden Features bereits erreicht hat. In WFS 2.0.0 wird diese Anzahl als <code>CountDefault</code> im <code>GetCapabilities</code>-Dokument stehen. In Kombinination mit <a href="http://gis.stackexchange.com/questions/86755/how-to-use-paging-in-a-wfs-query">Paging</a> <a href="https://trac.osgeo.org/mapserver/ticket/2799">wären</a> so zumindest sehr grosse Downloads möglich mit der Sicherheit wirklich auch alle Features zu bekommen.</p>
</div>
<div class="paragraph">
<p>Ist WFS also nur etwas für kleine Datenmengen? Oder aber hat jemand Antworten auf die Frage: Wie soll man WFS &laquo;richtig&raquo; nutzen?</p>
</div></p>

	<p class="author">
		Posted by Stefan Ziegler. |
		<a href="/tags/WFS.html">WFS</a>
		, <a href="/tags/QGIS.html">QGIS</a>
		, <a href="/tags/GeoServer.html">GeoServer</a>
		
	</p>

	<hr />

		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2016 Stefan Ziegler | Baked with <a href="http://jbake.org">JBake v2.4.0</a></p>
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../../../../js/jquery-1.11.1.min.js"></script>
    <script src="../../../../js/bootstrap.min.js"></script>
	<script src="../../../../js/prettify.js"></script>
  </body>
</html>
