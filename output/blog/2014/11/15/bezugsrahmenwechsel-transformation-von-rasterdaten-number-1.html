<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Bezugsrahmenwechsel: Transformation von Rasterdaten #1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link href="../../../../css/prettify.css" rel="stylesheet">
    <link href="../../../../css/sogeo.css" rel="stylesheet">

    <!-- web fonts -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,300' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.019/css/hack.min.css">
    
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../../favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
			<li><a href="../../../../index.html">Home</a></li>
			<li><a href="../../../../archive.html">Archive</a></li>
            <li><a href="../../../../feed.xml">Subscribe</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">

	<div class="page-header">
		<h1>Bezugsrahmenwechsel: Transformation von Rasterdaten #1</h1>
	</div>

	<p class="date"><em>15 November 2014</em></p>

	<p><div class="paragraph">
<p>Mit dem <a href="http://www.swisstopo.admin.ch/internet/swisstopo/de/home/products/software/products/chenyx06.html">NTv2-CHENyx06-Datensatz</a>  lassen sich beliebige Datenformate (Vektor und Raster) transformieren. So unterstützt z.B. <a href="http://sourcepole.ch/ntv2-transformations-with-qgis">QGIS</a> seit der Version 2.2 diese Möglichkeit der Datumstransformation. Die Genauigkeit dieser Methode ist im Kanton Solothurn nur marginal schlechter als die strenge Transformation mit dem FINELTRA-Algorithmus. Für die allermeisten Darstellungen am Bildschirm oder für die Transformation von Rasterdaten reicht die Genauigkeit völlig aus.</p>
</div>
<div class="paragraph">
<p>Ein NTv2-Datensatz kann in verschiedenen WMS-Servern auch dazu verwendet werden Transformationen on-the-fly durchzuführen (z.B. QGIS Server, <a href="http://docs.geoserver.org/latest/en/user/advanced/crshandling/coordtransforms.html">GeoServer</a>). Will man aber trotzdem die Rasterdaten nicht nur on-the-fly transformieren, sondern sie auch physisch vorliegen haben, kann man das mit einem kleinen Skript und <a href="http://www.gdal.org">GDAL</a> machen. Oftmals reicht für nicht-hochauflösende Rasterdaten z.B. eine Translation um +2 Mio / +1 Mio. Eine andere Variante ist die strenge Transformation der Metadaten (&laquo;Worldfile&raquo;). Für hochauflösende Rasterdaten funktioniert das nur noch bedingt.</p>
</div>
<div class="paragraph">
<p>Viele der Rasterdaten liegen in einem nahtlosen Mosaik vor (z.B. Orthofotos). Nach der Transformation sollen weiterhin keine Lücken und Überlappungen zwischen den einzelnen Kacheln sichtbar sein. Um das zu erreichen wird zuerst eine Shapedatei mit den einzelnen Kacheln als Polygon erstellt. Im Kanton Solothurn sind das 1km2-Kacheln:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../../../../../images/brw_raster_p1/kacheleinteilung.png" alt="Kacheleinteilung">
</div>
</div>
<div class="paragraph">
<p>Dieser sogenannte Tileindex wird mit <code>gdaltindex</code> erstellt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>gdaltindex -write_absolute_path ortho2014.shp *.tif</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dabei werden sämtliche Tiff-Dateien in dem Verzeichnis berücksichtigt. Mit der Option <code>-write_absolute_path</code> wird im Attribut <em>location</em> in der Shapedatei <em>ortho2014.shp</em> der absolute Pfad der Tiff-Dateien gespeichert.</p>
</div>
<div class="paragraph">
<p>Jetzt ist es Zeit für das kleine Pythonskript, dass schlussendlich nichts Anderes macht als für jede dieser Kacheln ein <code>gdal_warp</code>-Befehl mit passenden Parameter zusammenzustellen und auszuführen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight linenums"><code class="language-python" data-lang="python">#!/usr/bin/python
# -*- coding: utf-8 -*-

from osgeo import ogr, osr
import os

S_SRS = "+proj=somerc +lat_0=46.952405555555555N +lon_0=7.439583333333333E +ellps=bessel +x_0=600000 +y_0=200000 +towgs84=674.374,15.056,405.346 +units=m +units=m +k_0=1 +nadgrids=./chenyx06/chenyx06a.gsb"
T_SRS = "+proj=somerc +lat_0=46.952405555555555N +lon_0=7.439583333333333E +ellps=bessel +x_0=2600000 +y_0=1200000 +towgs84=674.374,15.056,405.346 +units=m +k_0=1 +nadgrids=@null"

ogr.UseExceptions()

shp = ogr.Open("mosaic/ortho2014.shp")
layer = shp.GetLayer(0)

for feature in layer:
    infileName = feature.GetField('location')
    geom = feature.GetGeometryRef()
    env = geom.GetEnvelope()

    minX = int(env[0] + 0.001 + 2000000)
    minY = int(env[2] + 0.001 + 1000000)
    maxX = int(env[1] + 0.001 + 2000000)
    maxY = int(env[3] + 0.001 + 1000000)

    outfileName = str(minX)[0:4] + str(minY)[0:4] + "_12_5cm.tif"
    outfileName = os.path.join(os.path.dirname(infileName), "lv95", outfileName)

    cmd = "/usr/local/gdal/gdal-dev/bin/gdalwarp -s_srs \"" + S_SRS + "\" -t_srs \"" + T_SRS + "\" -te "  + str(minX) + " " +  str(minY) + " " +  str(maxX) + " " +  str(maxY)
    cmd += " -tr 0.125 0.125 -wo NUM_THREADS=ALL_CPUS -co 'PHOTOMETRIC=RGB' -co 'TILED=YES' -co 'PROFILE=GeoTIFF'"
    cmd += " -co 'INTERLEAVE=PIXEL' -co 'COMPRESS=DEFLATE' -co 'BLOCKXSIZE=512' -co 'BLOCKYSIZE=512'"
    vrt = "/opt/Geodaten/ch/so/kva/orthofoto/2014/rgb/12_5cm/ortho2014rgb.vrt"
    cmd += " -r bilinear " + vrt + " " + outfileName
    os.system(cmd)

    cmd = "/usr/local/gdal/gdal-dev/bin/gdal_edit.py -a_srs EPSG:2056 " + outfileName
    os.system(cmd)

    cmd = "/usr/local/gdal/gdal-dev/bin/gdaladdo -r nearest --config COMPRESS_OVERVIEW DEFLATE --config GDAL_TIFF_OVR_BLOCKSIZE 512 " + outfileName + " 2 4 8 16 32 64 128"
    os.system(cmd)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Zeilen 4 - 5</strong>: Benötigte Module werden geladen.</p>
</div>
<div class="paragraph">
<p><strong>Zeilen 7 - 8</strong>: Es ist möglich neben EPSG-Codes für Transformation mit GDAL auch eigene proj4-Definitionen als Parameter zur übergeben. Bei der Verwendung von NTv2-Gittern ist das ein bisschen hakelig. Es gibt viele Varianten. Viele davon führen zu falschen Resultaten, zwei davon führen zu richtigen Resultaten. Abhängig davon welcher <a href="http://www.swisstopo.admin.ch/internet/swisstopo/de/home/products/software/products/chenyx06.html">NTv2-Datensatz</a> (<em>chenyx06a.gsb</em> oder <em>chenyx06etrs.gsb</em>) verwendet wird. Langer Rede kurzer Sinn: Das hier ist eine Kombination, die korrekt transformiert.</p>
</div>
<div class="paragraph">
<p><strong>Zeile 12 - 13</strong>: Die Shapedatei mit der Kacheleinteilung wird geöffnet und ein Layer wird angelegt.</p>
</div>
<div class="paragraph">
<p><strong>Zeilen 15 -16</strong>: Die For-Schleife bearbeitet jede Kachel einzeln. Zuerst wird das Attribut <em>location</em> ausgelesen. Es beinhaltet den kompletten absoluten Pfad der einzelnen Tiff-Datei. Davon verwenden wir aber später nur das Verzeichnis, da wir in ein Unterverzeichnis die resultierenden Tiff-Dateien speichern wollen.</p>
</div>
<div class="paragraph">
<p><strong>Zeilen 17 - 18</strong>: Die Geometrie der Kachel wird ausgelesen und die <em>Envelope</em> (Tupel mit den min/max Koordinatenwerten) berechnet.</p>
</div>
<div class="paragraph">
<p><strong>Zeilen 20 - 23</strong>: Aus der <em>Envelope</em> lesen wir die minimalen X- resp. Y-Werte. Die resultierenden Kacheln sollen wie die Ausgangskacheln &laquo;schöne&raquo; Kilometerkacheln sein. Dazu wird einfach 2 Mio. resp. 1 Mio dazugerechnet. Weil der <code>int</code>-Befehl abrundet (?), muss den Koordinatenwerten ein kleiner Wert dazu addiert werden, um keine falschen Ganzzahleswerte zu bekommen.</p>
</div>
<div class="paragraph">
<p><strong>Zeilen 25 - 26</strong>: Aus den Koordinatenwerten wird der Dateinnamen der neuen Kacheln bestimmt.</p>
</div>
<div class="paragraph">
<p><strong>Zeilen 28 - 33</strong>: Hier geschieht die Zauberei. Als Ausgangsdatei wird nicht die einzelne Kacheln verwendet sondern <em>immer</em> die vrt-Datei (Diese muss u.U. vorgängig noch <a href="http://www.gdal.org/gdalbuildvrt.html">erstellt</a> werden). GDAL sieht jetzt nur eine einzelne, flächendeckende Rasterdatei. Somit muss nur noch der Ausschnitt gewählt werden, der aus dieser einzelnen Rasterdatei ausgeschnitten werden soll. Dieser Ausschnitt wurde ja bereits in den Zeilen 20 - 23 ermittelt. Das Resultat wird wiederum in einer Tiff-Datei gespeichert.</p>
</div>
<div class="paragraph">
<p><strong>Zeilen 35 - 39</strong>: Anschliessend werden in der neuen GeoTiff-Datei noch korrekte Metadaten zum Koordinatensystem gespeichert und es werden interne Overview gerechnet.</p>
</div>
<div class="paragraph">
<p>Das Resultat sind einzelne Orthofotokacheln, die sich weder überlappen noch sind Lücken zwischen den Kacheln vorhanden. Die Übergänge sind wie im Ausgangsmaterial nicht sichtbar. Einzig am Perimeterrand sind kleine schwarze Ränder sichtbar. Diese entstehen weil im Ausgangsmaterial in diesem Bereich <em>keine</em> Daten vorhanden sind. Liegt das Ausgangsmaterial im Bezugsrahmen LV95 vor und wird in den Bezugsrahmen LV03 transformiert, dürfte dieses Phänomen nicht auftreten.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../../../../../images/brw_raster_p1/orthorand.png" alt="Orthofoto Perimeterrand">
</div>
</div>
<div class="paragraph">
<p>Der Transformationsprozess dauerte für 384 Kacheln circa 1h 45m. Ein Qualitätsverlust aufgrund des Resamplings ist <em>nicht</em> feststellbar.</p>
</div></p>

	<p class="author">
		Posted by Stefan Ziegler. |
		<a href="/tags/GDAL.html">GDAL</a>
		, <a href="/tags/OGR.html">OGR</a>
		, <a href="/tags/Bezugsrahmenwechsel.html">Bezugsrahmenwechsel</a>
		, <a href="/tags/LV95.html">LV95</a>
		, <a href="/tags/Raster.html">Raster</a>
		, <a href="/tags/NTv2.html">NTv2</a>
		
	</p>

	<hr />

		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2016 Stefan Ziegler | Baked with <a href="http://jbake.org">JBake v2.4.0</a></p>
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../../../../js/jquery-1.11.1.min.js"></script>
    <script src="../../../../js/bootstrap.min.js"></script>
	<script src="../../../../js/prettify.js"></script>
  </body>
</html>
